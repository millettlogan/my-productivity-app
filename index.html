<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green vs Blue Ultimate</title>
    <style>
        :root { --green: #27ae60; --blue: #2980b9; --dark: #2c3e50; --light: #ecf0f1; --gold: #f1c40f; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--light); margin: 0; padding: 15px; color: var(--dark); font-size: 16px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .balance { font-size: 2.5rem; font-weight: bold; color: var(--blue); text-align: center; }
        .btn { border: none; padding: 15px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin: 5px 0; font-size: 1rem; }
        .btn-green { background: var(--green); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-ghost { background: #ddd; color: var(--dark); }
        .hidden { display: none; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-top: 5px; font-size: 1rem; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 8px; border-left: 5px solid #ccc; }
        .history-green { border-left-color: var(--green); }
        .history-blue { border-left-color: var(--blue); }
        .todo-item { border-left-color: var(--gold); }
        small { color: #7f8c8d; display: block; }
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        datalist { display: none; }
    </style>
</head>
<body>

    <div id="home">
        <div class="card">
            <h3 style="margin:0; text-align:center;">Free Time Bank</h3>
            <div class="balance" id="bal">0m</div>
        </div>

        <div id="active-timer" class="card hidden" style="border: 2px solid var(--blue);">
            <h2 id="timer-display" style="text-align:center; font-size:3rem; margin:10px 0;">00:00</h2>
            <button class="btn btn-blue" onclick="stopFreeTime()">Stop & Deduct Time</button>
        </div>

        <button class="btn btn-green" onclick="showScreen('log-activity')">‚ö° Log Work / Progress</button>
        <button class="btn btn-blue" id="start-btn" onclick="startFreeTime()">Start Free Time</button>
        
        <div class="nav-grid">
            <button class="btn btn-ghost" onclick="showScreen('planner')">üìÖ Planner</button>
            <button class="btn btn-ghost" onclick="showScreen('history')">üìú History</button>
            <button class="btn btn-ghost" onclick="showScreen('manage-tasks')">‚öôÔ∏è Library</button>
            <button class="btn btn-ghost" onclick="showScreen('stats')">üìä Report</button>
        </div>
    </div>

    <div id="planner" class="hidden">
        <div class="card">
            <h2>Task Planner</h2>
            <button class="btn btn-green" onclick="toggleElement('add-todo-form')">+ Add Future Task</button>
            
            <div id="add-todo-form" class="hidden" style="margin-top:15px; border-top: 1px solid #eee; padding-top:15px;">
                <label>Task Name</label><input type="text" id="todo-name" placeholder="Board Meeting">
                <label>Category</label><input list="category-list" id="todo-cat" placeholder="Select or Type New">
                <label>Due Date</label><input type="date" id="todo-date">
                <label>Priority (1-5)</label><input type="number" id="todo-pri" value="3" min="1" max="5">
                <button class="btn btn-green" onclick="addTodo()">Save to Planner</button>
            </div>
            <hr>
            <h3>Active Tasks</h3>
            <div id="todo-list"></div>
            <button class="btn btn-ghost" onclick="showScreen('home')">Back</button>
        </div>
    </div>

    <div id="log-activity" class="hidden">
        <div class="card">
            <h2>Log Your Progress</h2>
            <label>What are you working on?</label>
            <select id="task-select" onchange="checkNewTask(this.value)"></select>

            <div id="new-task-fields" class="hidden">
                <label>Task Name</label><input type="text" id="new-name">
                <label>Category</label><input list="category-list" id="new-cat" placeholder="Select or Type New">
                <label>Priority (1-5)</label><input type="number" id="new-pri-manual" value="3">
            </div>

            <div style="margin-top:15px;">
                <label>Minutes Spent Working</label>
                <input type="number" id="log-val" value="30">
                <label id="complete-check-label" class="hidden"><input type="checkbox" id="is-complete"> Mark as Finished?</label>
            </div>

            <button class="btn btn-green" onclick="submitLog()">Confirm & Earn</button>
            <button class="btn btn-ghost" onclick="showScreen('home')">Back</button>
        </div>
    </div>

    <div id="history" class="hidden">
        <div class="card">
            <h2>Recent History</h2>
            <div id="history-list"></div>
            <button class="btn btn-ghost" onclick="showScreen('home')">Back</button>
        </div>
    </div>

    <div id="manage-tasks" class="hidden"><div class="card"><h2>Library</h2><div id="task-list-container"></div><button class="btn btn-ghost" onclick="showScreen('home')">Back</button></div></div>
    
    <div id="stats" class="hidden">
        <div class="card">
            <h2>Weekly Report</h2>
            <div id="report-content"></div>
            <button class="btn btn-blue" onclick="emailReport()">üìß Email This Report</button>
            <button class="btn btn-ghost" onclick="showScreen('home')">Back</button>
        </div>
    </div>

    <datalist id="category-list"></datalist>

    <script>
        let rawData = JSON.parse(localStorage.getItem('prodAppData')) || {};
        let data = {
            balance: rawData.balance || 0,
            tasks: rawData.tasks || [],
            logs: rawData.logs || [],
            todos: rawData.todos || [],
            lastAllowance: rawData.lastAllowance || ""
        };

        let timerInt, seconds = 0;

        function save() { 
            localStorage.setItem('prodAppData', JSON.stringify(data)); 
            updateUI(); 
            updateCategoryList();
        }

        function toggleElement(id) { document.getElementById(id).classList.toggle('hidden'); }

        function showScreen(id) {
            ['home', 'planner', 'log-activity', 'manage-tasks', 'stats', 'history'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'log-activity') populateDropdown();
            if(id === 'planner') renderPlanner();
            if(id === 'history') renderHistory();
            if(id === 'manage-tasks') renderLibrary();
            if(id === 'stats') generateReport();
            updateCategoryList();
        }

        function updateCategoryList() {
            const cats = new Set([...data.tasks.map(t=>t.cat), ...data.todos.map(t=>t.cat), ...data.logs.map(l=>l.cat)]);
            const list = document.getElementById('category-list');
            list.innerHTML = Array.from(cats).filter(c => c && c !== 'Blue' && c !== 'Bonus').map(c => `<option value="${c}">`).join('');
        }

        function addTodo() {
            const name = document.getElementById('todo-name').value;
            if(!name) return;
            data.todos.push({
                id: Date.now(),
                name: name,
                cat: document.getElementById('todo-cat').value || 'General',
                date: document.getElementById('todo-date').value,
                pri: parseInt(document.getElementById('todo-pri').value) || 3,
                timeInvested: 0
            });
            save(); renderPlanner();
            document.getElementById('todo-name').value = '';
            toggleElement('add-todo-form');
        }

        function renderPlanner() {
            document.getElementById('todo-list').innerHTML = data.todos.map(t => `
                <div class="list-item todo-item">
                    <span><strong>${t.name}</strong><small>Due: ${t.date || '---'} | Invested: ${t.timeInvested}m</small></span>
                    <button class="btn-ghost" style="padding:5px; width:auto;" onclick="deleteTodo(${t.id})">Del</button>
                </div>
            `).join('') || "No active planner tasks.";
        }

        function deleteTodo(id) { if(confirm("Remove from planner?")) { data.todos = data.todos.filter(t => t.id !== id); save(); renderPlanner(); } }

        function populateDropdown() {
            let sel = document.getElementById('task-select');
            let options = '<option value="new">+ Add One-Off Entry</option>';
            data.todos.forEach(t => options += `<option value="todo-${t.id}">[PLANNER] ${t.name}</option>`);
            data.tasks.forEach(t => options += `<option value="lib-${t.name}">${t.name}</option>`);
            sel.innerHTML = options;
        }

        function checkNewTask(val) {
            document.getElementById('new-task-fields').classList.toggle('hidden', val !== 'new');
            document.getElementById('complete-check-label').classList.toggle('hidden', !val.startsWith('todo-'));
        }

        function submitLog() {
            const val = parseInt(document.getElementById('log-val').value) || 0;
            const selectVal = document.getElementById('task-select').value;
            let entryName, entryCat, entryPri, reward = 0;

            if(selectVal === 'new') {
                entryName = document.getElementById('new-name').value || "Quick Task";
                entryCat = document.getElementById('new-cat').value || 'General';
                entryPri = parseInt(document.getElementById('new-pri-manual').value) || 3;
                reward = Math.floor(val * (0.4 + (entryPri * 0.2)));
            } else if(selectVal.startsWith('todo-')) {
                let id = selectVal.split('-')[1];
                let todo = data.todos.find(t => t.id == id);
                entryName = todo.name; entryCat = todo.cat; entryPri = todo.pri;
                todo.timeInvested += val;
                reward = Math.floor(val * (0.4 + (entryPri * 0.2)));
                if(document.getElementById('is-complete').checked) {
                    reward += (todo.pri * 10);
                    data.todos = data.todos.filter(t => t.id != id);
                }
            } else {
                let name = selectVal.split('lib-')[1];
                let lib = data.tasks.find(t => t.name == name);
                entryName = lib.name; entryCat = lib.cat; entryPri = lib.pri;
                reward = Math.floor(val * (0.4 + (entryPri * 0.2)));
            }

            data.balance += reward;
            data.logs.push({ name: entryName, cat: entryCat, reward: reward, timeSpent: val, date: new Date().toISOString(), logId: Date.now() });
            save(); showScreen('home');
        }

        function renderHistory() {
            document.getElementById('history-list').innerHTML = [...data.logs].reverse().slice(0,20).map(l => `
                <div class="list-item ${l.reward > 0 ? 'history-green' : 'history-blue'}">
                    <span><strong>${l.name}</strong><small>${l.reward}m | ${l.timeSpent || 0}m work</small></span>
                    <button onclick="deleteLog(${l.logId})" style="color:var(--red); background:none; border:none; font-weight:bold;">UNDO</button>
                </div>
            `).join('') || "No history.";
        }

        function deleteLog(logId) {
            if(confirm("Delete this entry? Balance will be adjusted.")) {
                const idx = data.logs.findIndex(l => l.logId === logId);
                if(idx > -1) {
                    data.balance -= data.logs[idx].reward;
                    data.logs.splice(idx, 1);
                    save(); renderHistory();
                }
            }
        }

        function generateReport() {
            const container = document.getElementById('report-content');
            let green = 0, blue = 0, workTime = 0;
            const cats = {};
            data.logs.filter(l => new Date(l.date) > new Date(Date.now() - 7*86400000)).forEach(l => {
                if(l.reward > 0) { green += l.reward; workTime += (l.timeSpent || 0); cats[l.cat] = (cats[l.cat] || 0) + (l.timeSpent || 0); }
                else { blue += Math.abs(l.reward); }
            });
            let html = `<h3>Weekly Totals</h3><p>Work: ${workTime}m | Earned: ${green}m | Spent: ${blue}m</p><hr>`;
            for(let c in cats) html += `<div style="display:flex; justify-content:space-between; padding:3px 0;"><span>${c}</span><span>${cats[c]}m</span></div>`;
            html += `<hr><h3>In Progress (Planner)</h3>`;
            html += data.todos.map(t => `<div style="display:flex; justify-content:space-between; font-size:0.9rem;"><span>${t.name}</span><span>${t.timeInvested}m so far</span></div>`).join('') || "<p>No active projects.</p>";
            container.innerHTML = html;
        }

        function emailReport() {
            const report = document.getElementById('report-content').innerText;
            window.location.href = `mailto:?subject=Productivity Report&body=${encodeURIComponent(report)}`;
        }

        function renderLibrary() { document.getElementById('task-list-container').innerHTML = data.tasks.map((t,i) => `<div class="list-item"><span><strong>${t.name}</strong></span><button onclick="data.tasks.splice(${i},1);save();renderLibrary();">Del</button></div>`).join('') || "Library empty."; }
        function startFreeTime() { if(data.balance <= 0) return alert("Bank empty!"); document.getElementById('active-timer').classList.remove('hidden'); timerInt = setInterval(() => { seconds++; document.getElementById('timer-display').innerText = Math.floor(seconds/60) + ":" + (seconds%60).toString().padStart(2,'0'); }, 1000); }
        function stopFreeTime() { clearInterval(timerInt); let used = Math.ceil(seconds/60); data.balance -= used; data.logs.push({name:'Free Time', cat: 'Blue', reward:-used, date:new Date().toISOString(), logId:Date.now()}); document.getElementById('active-timer').classList.add('hidden'); seconds=0; save(); }
        function updateUI() { document.getElementById('bal').innerText = data.balance + 'm'; }

        updateUI();
    </script>
</body>
</html>
