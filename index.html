<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green vs Blue Ultimate</title>
    <style>
        :root { --green: #27ae60; --blue: #2980b9; --dark: #2c3e50; --light: #ecf0f1; --gold: #f1c40f; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--light); margin: 0; padding: 15px; color: var(--dark); font-size: 16px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .balance { font-size: 2.5rem; font-weight: bold; color: var(--blue); text-align: center; }
        .btn { border: none; padding: 15px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin: 5px 0; font-size: 1rem; }
        .btn-green { background: var(--green); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-ghost { background: #ddd; color: var(--dark); }
        .hidden { display: none; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-top: 5px; font-size: 1rem; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 8px; border-left: 5px solid #ccc; }
        .history-green { border-left-color: var(--green); background: #f0fff4; }
        .history-blue { border-left-color: var(--blue); background: #f0f7ff; }
        .todo-item { border-left-color: var(--gold); }
        small { color: #7f8c8d; display: block; }
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ratio-tag { font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; color: #555; font-weight: bold; }
        .search-box { margin-bottom: 10px; border: 2px solid var(--blue); }
        .report-sec { border-bottom: 1px solid #eee; padding: 10px 0; }
        .report-sec:last-child { border: none; }
    </style>
</head>
<body>

    <div id="home">
        <div class="card">
            <h3 style="margin:0; text-align:center;">Free Time Bank</h3>
            <div class="balance" id="bal">0m</div>
        </div>

        <div id="active-timer" class="card hidden" style="border: 2px solid var(--blue);">
            <h2 id="timer-display" style="text-align:center; font-size:3rem; margin:10px 0;">00:00</h2>
            <button class="btn btn-blue" onclick="stopFreeTime()">Stop & Deduct Time</button>
        </div>

        <button class="btn btn-green" onclick="showScreen('log-activity')">‚ö° Log Work / Progress</button>
        <button class="btn btn-blue" id="start-btn" onclick="startFreeTime()">Start Free Time</button>
        
        <div class="nav-grid">
            <button class="btn btn-ghost" onclick="showScreen('planner')">üìÖ Planner</button>
            <button class="btn btn-ghost" onclick="showScreen('history')">üìú History</button>
            <button class="btn btn-ghost" onclick="showScreen('manage-tasks')">‚öôÔ∏è Library</button>
            <button class="btn btn-ghost" onclick="showScreen('stats')">üìä Report</button>
        </div>
    </div>

    <div id="planner" class="hidden">
        <div class="card">
            <h2>Task Planner</h2>
            <button class="btn btn-green" onclick="toggleElement('add-todo-form')">+ Add Future Task</button>
            <div id="add-todo-form" class="hidden" style="margin-top:15px; border-top: 1px solid #eee; padding-top:15px;">
                <label>Task Name</label><input type="text" id="todo-name" placeholder="Board Meeting">
                <label>Category</label><input list="category-list" id="todo-cat">
                <label>Due Date</label><input type="date" id="todo-date">
                <label>Priority (1-5)</label><input type="number" id="todo-pri" value="3" min="1" max="5">
                <label style="font-size: 0.9rem; display:block; margin: 10px 0;"><input type="checkbox" id="todo-recurring"> Repeat Monthly?</label>
                <button class="btn btn-green" onclick="addTodo()">Save to Planner</button>
            </div>
            <hr>
            <h3>Active Tasks</h3>
            <div id="todo-list"></div>
            <button class="btn btn-ghost" onclick="showScreen('home')">Back</button>
        </div>
    </div>

    <div id="log-activity" class="hidden">
        <div class="card">
            <h2>Log Your Progress</h2>
            <label>What are you working on?</label>
            <select id="task-select" onchange="checkNewTask(this.value)"></select>

            <div id="new-task-fields" class="hidden" style="margin-top:15px; border-top: 1px solid #eee; padding-top:10px;">
                <label>Task Name</label><input type="text" id="new-name">
                <label>Category</label><input list="category-list" id="new-cat">
                <label>Priority (1-5)</label><input type="number" id="new-pri-manual" value="3" min="1" max="5" oninput="updateRateDisplay(this.value, 'new-rate')">
                <div style="margin-top:5px;"><small id="new-rate">Earn Rate: 1.0x</small></div>
                <label style="font-size: 0.9rem; margin-top:10px;"><input type="checkbox" id="save-to-lib"> Add to permanent Library?</label>
            </div>

            <div id="log-inputs" style="margin-top:15px;">
                <label>Minutes Spent Working</label>
                <input type="number" id="log-val" value="30">
                <label id="complete-check-label" class="hidden"><input type="checkbox" id="is-complete"> Mark as Finished?</label>
            </div>

            <button class="btn btn-green" onclick="submitLog()">Confirm & Earn</button>
            <button class="btn btn-ghost" onclick="showScreen('home')">Back</button>
        </div>
    </div>

    <div id="history" class="hidden">
        <div class="card">
            <h2>Recent History</h2>
            <input type="text" id="history-search" class="search-box" placeholder="Filter history..." oninput="renderHistory()">
            <div id="history-list"></div>
            <button class="btn btn-ghost" onclick="showScreen('home')">Back</button>
        </div>
    </div>

    <div id="manage-tasks" class="hidden">
        <div class="card">
            <h2>Task Library</h2>
            <button class="btn btn-blue" onclick="toggleElement('lib-add-form')">+ New Library Task</button>
            <div id="lib-add-form" class="hidden" style="margin-top:15px; border-top: 1px solid #eee; padding-top:10px;">
                <input type="text" id="lib-new-name" placeholder="Task Name">
                <input list="category-list" id="lib-new-cat" placeholder="Category">
                <input type="number" id="lib-new-pri" value="3" min="1" max="5" oninput="updateRateDisplay(this.value, 'lib-rate-preview')">
                <small id="lib-rate-preview">Earn Rate: 1.0x</small>
                <button class="btn btn-blue" onclick="addDirectToLibrary()">Add to Library</button>
            </div>
            <hr>
            <input type="text" id="lib-search" class="search-box" placeholder="Search tasks..." oninput="renderLibrary()">
            <div id="task-list-container"></div>
            <button class="btn btn-ghost" onclick="showScreen('home')">Back</button>
        </div>
    </div>

    <div id="stats" class="hidden">
        <div class="card">
            <h2>Performance Report</h2>
            <div id="report-content"></div>
            <button class="btn btn-blue" onclick="emailReport()">üìß Email This Report</button>
            <button class="btn btn-ghost" onclick="showScreen('home')">Back</button>
        </div>
    </div>

    <datalist id="category-list"></datalist>

    <script>
        let rawData = JSON.parse(localStorage.getItem('prodAppData')) || {};
        let data = {
            balance: rawData.balance || 0,
            tasks: rawData.tasks || [],
            logs: rawData.logs || [],
            todos: rawData.todos || [],
            lastAllowance: rawData.lastAllowance || ""
        };

        let timerInt, seconds = 0;

        function save() { 
            if(data.balance < 0) data.balance = 0;
            localStorage.setItem('prodAppData', JSON.stringify(data)); 
            updateUI(); 
            updateCategoryList();
        }

        function checkDailyAllowance() {
            const today = new Date().toLocaleDateString();
            if(data.lastAllowance !== today) {
                data.balance += 20; 
                data.lastAllowance = today;
                data.logs.push({ name: 'Daily Allowance', cat: 'Bonus', reward: 20, timeSpent: 0, date: new Date().toISOString(), logId: Date.now() });
                save();
            }
        }

        function toggleElement(id) { document.getElementById(id).classList.toggle('hidden'); }

        function showScreen(id) {
            ['home', 'planner', 'log-activity', 'manage-tasks', 'stats', 'history'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'log-activity') populateDropdown();
            if(id === 'planner') renderPlanner();
            if(id === 'history') renderHistory();
            if(id === 'manage-tasks') renderLibrary();
            if(id === 'stats') generateReport();
            updateCategoryList();
        }

        function updateRateDisplay(pri, targetId) {
            let rate = (0.4 + (pri * 0.2)).toFixed(1);
            document.getElementById(targetId).innerText = `Earn Rate: ${rate}x`;
        }

        function updateCategoryList() {
            const cats = new Set([...data.tasks.map(t=>t.cat), ...data.todos.map(t=>t.cat), ...data.logs.map(l=>l.cat)]);
            document.getElementById('category-list').innerHTML = Array.from(cats).filter(c => c && c !== 'Blue' && c !== 'Bonus').map(c => `<option value="${c}">`).join('');
        }

        function addDirectToLibrary() {
            const name = document.getElementById('lib-new-name').value;
            const cat = document.getElementById('lib-new-cat').value || 'General';
            const pri = parseInt(document.getElementById('lib-new-pri').value) || 3;
            if(!name) return;
            data.tasks.push({name, cat, pri, lastDone: null});
            save(); renderLibrary();
            document.getElementById('lib-new-name').value = ''; toggleElement('lib-add-form');
        }

        function addTodo() {
            const name = document.getElementById('todo-name').value;
            if(!name) return;
            data.todos.push({ id: Date.now(), name: name, cat: document.getElementById('todo-cat').value || 'General', date: document.getElementById('todo-date').value, pri: parseInt(document.getElementById('todo-pri').value) || 3, recurring: document.getElementById('todo-recurring').checked, timeInvested: 0 });
            save(); renderPlanner();
            document.getElementById('todo-name').value = ''; toggleElement('add-todo-form');
        }

        function renderPlanner() {
            document.getElementById('todo-list').innerHTML = data.todos.map(t => `<div class="list-item todo-item"><span><strong>${t.name}</strong><small>Due: ${t.date || '---'}</small></span><button class="btn-ghost" style="padding:5px; width:auto;" onclick="deleteTodo(${t.id})">Del</button></div>`).join('') || "No active tasks.";
        }
        function deleteTodo(id) { if(confirm("Remove task?")) { data.todos = data.todos.filter(t => t.id !== id); save(); renderPlanner(); } }

        function populateDropdown() {
            let sel = document.getElementById('task-select');
            let options = '<option value="new">+ Add One-Off Entry</option>';
            data.todos.forEach(t => options += `<option value="todo-${t.id}">[PLANNER] ${t.name}</option>`);
            data.tasks.forEach(t => options += `<option value="lib-${t.name}">${t.name}</option>`);
            sel.innerHTML = options;
            checkNewTask('new');
        }

        function checkNewTask(val) {
            document.getElementById('new-task-fields').classList.toggle('hidden', val !== 'new');
            document.getElementById('complete-check-label').classList.toggle('hidden', !val.startsWith('todo-'));
        }

        function submitLog() {
            const val = parseInt(document.getElementById('log-val').value) || 0;
            const selectVal = document.getElementById('task-select').value;
            let entryName, entryCat, entryPri, reward = 0;

            if(selectVal === 'new') {
                entryName = document.getElementById('new-name').value || "Quick Task";
                entryCat = document.getElementById('new-cat').value || 'General';
                entryPri = parseInt(document.getElementById('new-pri-manual').value) || 3;
                reward = Math.floor(val * (0.4 + (entryPri * 0.2)));
                if(document.getElementById('save-to-lib').checked) data.tasks.push({name: entryName, cat: entryCat, pri: entryPri, lastDone: new Date().toISOString()});
            } else if(selectVal.startsWith('todo-')) {
                let id = selectVal.split('-')[1];
                let todo = data.todos.find(t => t.id == id);
                entryName = todo.name; entryCat = todo.cat; entryPri = todo.pri;
                todo.timeInvested += val;
                reward = Math.floor(val * (0.4 + (entryPri * 0.2)));
                if(document.getElementById('is-complete').checked) {
                    reward += (todo.pri * 10);
                    if(todo.recurring && todo.date) {
                        let nextDate = new Date(todo.date);
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        todo.date = nextDate.toISOString().split('T')[0];
                        todo.timeInvested = 0;
                    } else { data.todos = data.todos.filter(t => t.id != id); }
                }
            } else {
                let name = selectVal.split('lib-')[1];
                let lib = data.tasks.find(t => t.name == name);
                entryName = lib.name; entryCat = lib.cat; entryPri = lib.pri;
                lib.lastDone = new Date().toISOString();
                reward = Math.floor(val * (0.4 + (entryPri * 0.2)));
            }
            data.balance += reward;
            data.logs.push({ name: entryName, cat: entryCat, reward: reward, timeSpent: val, date: new Date().toISOString(), logId: Date.now() });
            save(); showScreen('home');
            alert(`Earned ${reward}m Blue Time!`);
        }

        function renderHistory() {
            const query = document.getElementById('history-search').value.toLowerCase();
            document.getElementById('history-list').innerHTML = [...data.logs].reverse()
                .filter(l => l.name.toLowerCase().includes(query) || l.cat.toLowerCase().includes(query))
                .slice(0,30).map(l => `<div class="list-item ${l.reward > 0 ? 'history-green' : 'history-blue'}"><span><strong>${l.name}</strong><small>${l.reward > 0 ? '+' : ''}${l.reward}m earned | ${l.timeSpent || 0}m work</small></span><button onclick="deleteLog(${l.logId})" style="color:var(--red); background:none; border:none; font-weight:bold;">UNDO</button></div>`).join('') || "No matching history.";
        }

        function deleteLog(logId) {
            if(confirm("Undo this entry?")) {
                const idx = data.logs.findIndex(l => l.logId === logId);
                if(idx > -1) { data.balance -= data.logs[idx].reward; data.logs.splice(idx, 1); save(); renderHistory(); }
            }
        }

        function generateReport() {
            const container = document.getElementById('report-content');
            let green = 0, blue = 0, workTime = 0;
            const cats = {};
            data.logs.filter(l => new Date(l.date) > new Date(Date.now() - 7*86400000)).forEach(l => {
                if(l.reward > 0) { green += l.reward; workTime += (l.timeSpent || 0); cats[l.cat] = (cats[l.cat] || 0) + (l.timeSpent || 0); }
                else { blue += Math.abs(l.reward); }
            });

            const efficiency = workTime > 0 ? (green / workTime).toFixed(2) : 0;

            let html = `<div class="report-sec"><h3>Weekly Summary</h3>
                <p>Total Work: <strong>${workTime}m</strong></p>
                <p>Blue Time Earned: <span style="color:var(--green)">${green}m</span></p>
                <p>Blue Time Spent: <span style="color:var(--blue)">${blue}m</span></p>
                <p>Efficiency Ratio: <strong>${efficiency}x</strong></p></div>`;
            
            html += `<div class="report-sec"><h3>Category Breakdown</h3>`;
            for(let c in cats) html += `<div style="display:flex; justify-content:space-between; margin:4px 0;"><span>${c}</span><span>${cats[c]}m</span></div>`;
            html += `</div><div class="report-sec"><h3>Planner Progress</h3>`;
            html += data.todos.map(t => `<div style="margin-bottom:8px;"><strong>${t.name}</strong><br><small>Invested: ${t.timeInvested}m</small></div>`).join('') || "No active projects.";
            html += `</div>`;
            container.innerHTML = html;
        }

        function emailReport() { window.location.href = `mailto:?subject=Productivity Report&body=${encodeURIComponent(document.getElementById('report-content').innerText)}`; }
        
        function renderLibrary() {
            const query = document.getElementById('lib-search').value.toLowerCase();
            document.getElementById('task-list-container').innerHTML = data.tasks
                .filter(t => t.name.toLowerCase().includes(query) || t.cat.toLowerCase().includes(query))
                .map((t,i) => {
                let lastDoneText = "Never";
                if(t.lastDone) {
                    const days = Math.floor((new Date() - new Date(t.lastDone)) / 86400000);
                    lastDoneText = days === 0 ? "Today" : days + "d ago";
                }
                return `<div class="list-item"><span><strong>${t.name}</strong><br><small>${t.cat} | ${lastDoneText}</small></span><button class="btn-ghost" style="width:auto; padding:5px; color:var(--red);" onclick="data.tasks.splice(${i},1);save();renderLibrary();">Del</button></div>`;
            }).join('') || "No tasks found.";
        }

        function startFreeTime() { if(data.balance <= 0) return alert("Bank empty!"); document.getElementById('active-timer').classList.remove('hidden'); timerInt = setInterval(() => { seconds++; document.getElementById('timer-display').innerText = Math.floor(seconds/60) + ":" + (seconds%60).toString().padStart(2,'0'); }, 1000); }
        function stopFreeTime() { clearInterval(timerInt); let used = Math.ceil(seconds/60); data.balance -= used; data.logs.push({name:'Free Time', cat: 'Blue', reward:-used, date:new Date().toISOString(), logId:Date.now()}); document.getElementById('active-timer').classList.add('hidden'); seconds=0; save(); }
        function updateUI() { document.getElementById('bal').innerText = Math.max(0, data.balance) + 'm'; }

        checkDailyAllowance();
        updateUI();
    </script>
</body>
</html>
